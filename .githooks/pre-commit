#!/bin/bash
# Pre-commit hook to generate cluster-specific app directories and Kargo pipelines
# 
# This hook runs Go scripts that:
# 1. Generate cluster-specific directories under apps/clusters/ for ApplicationSet
# 2. Generate Kargo pipeline configs under apps/kargo-configs/
#
# Setup: git config core.hooksPath .githooks

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if Go is installed
if ! command -v go &> /dev/null; then
    echo "Warning: Go is not installed, skipping code generation"
    echo "Install Go and run the scripts manually:"
    echo "  go run scripts/generate-cluster-apps.go"
    echo "  go run scripts/generate-kargo-pipelines.go"
    exit 0
fi

# Run from the scripts directory (where go.mod is)
cd "$REPO_ROOT/scripts"

# Generate cluster-specific app directories
CLUSTER_SCRIPT="generate-cluster-apps.go"
if [ -f "$CLUSTER_SCRIPT" ]; then
    echo "Generating cluster-specific app directories..."
    go run "$CLUSTER_SCRIPT"
else
    echo "Warning: $CLUSTER_SCRIPT not found, skipping"
fi

# Generate Kargo pipeline configs
KARGO_SCRIPT="generate-kargo-pipelines.go"
if [ -f "$KARGO_SCRIPT" ]; then
    echo "Generating Kargo pipeline configs..."
    go run "$KARGO_SCRIPT"
else
    echo "Warning: $KARGO_SCRIPT not found, skipping"
fi

# Stage any generated/modified files
cd "$REPO_ROOT"
if [ -d "apps/clusters" ]; then
    git add apps/clusters/
fi
if [ -d "apps/kargo-configs" ]; then
    git add apps/kargo-configs/
fi

echo "Generated files staged."

