#!/bin/bash
# Pre-commit hook to generate cluster-specific app directories and Kargo pipelines
# 
# This hook runs a Go script that:
# 1. Generates cluster-specific directories under apps/clusters/ for ApplicationSet
# 2. Generates Kargo pipeline configs under apps/kargo-configs/
#
# Setup: git config core.hooksPath .githooks

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if Go is installed
if ! command -v go &> /dev/null; then
    echo "Warning: Go is not installed, skipping code generation"
    echo "Install Go and run the script manually:"
    echo "  go run scripts/generate-configs.go"
    exit 0
fi

# Run from the scripts directory (where go.mod is)
cd "$REPO_ROOT/scripts"

# Generate cluster-specific app directories and Kargo pipeline configs
GENERATE_SCRIPT="generate-configs.go"
if [ -f "$GENERATE_SCRIPT" ]; then
    echo "Generating cluster-specific app directories and Kargo pipeline configs..."
    go run "$GENERATE_SCRIPT"
else
    echo "Warning: $GENERATE_SCRIPT not found, skipping"
fi

# Stage any generated/modified files
cd "$REPO_ROOT"
if [ -d "apps/clusters" ]; then
    git add apps/clusters/
fi
if [ -d "apps/kargo-configs" ]; then
    git add apps/kargo-configs/
fi

echo "Generated files staged."
