{{- if .Values.gitRepo.url }}
# ApplicationSet for infrastructure apps
# Discovers apps from generated cluster-specific directories in apps/clusters/<cluster>/infra/
# 
# To add a new infra app:
#   1. Create apps/infra/<app-name>/ with Chart.yaml, values.yaml, and app-config.yaml
#   2. In app-config.yaml, list target clusters under 'targetClusters'
#   3. Run 'go run scripts/generate-configs.go' (or commit - pre-commit hook will run it)
#
# To scope an app to specific clusters: edit app-config.yaml targetClusters list
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: infra-apps
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: {{ .Values.gitRepo.url }}
        revision: {{ .Values.gitRepo.revision }}
        files:
          # Cluster-specific path - only discovers apps enabled for THIS cluster
          # Generated by scripts/generate-configs.go
          - path: apps/clusters/{{ .Values.clusterName }}/infra/*/app-config.yaml
  template:
    metadata:
      # App name from directory: apps/clusters/<cluster>/infra/[app-name]/app-config.yaml
      #                          0    1        2         3     4
      name: '{{ `{{ index .path.segments 4 }}` }}'
      annotations:
        # Authorize Kargo to manage this Application
        # Project = app name, Stage = cluster name
        kargo.akuity.io/authorized-stage: '{{ `{{ index .path.segments 4 }}` }}:{{ .Values.clusterName }}'
    spec:
      project: default
      source:
        repoURL: {{ .Values.gitRepo.url }}
        targetRevision: {{ .Values.gitRepo.revision }}
        # Use chartPath from generated app-config.yaml to point to shared chart
        path: '{{ `{{ .chartPath }}` }}'
        helm:
          valueFiles:
            - values.yaml
            - values-{{ .Values.clusterName }}.yaml
          # Skip missing per-cluster values files - allows apps to work with just values.yaml
          ignoreMissingValueFiles: true
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ `{{ index .path.segments 4 }}` }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
{{- end }}
