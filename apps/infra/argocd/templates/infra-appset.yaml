{{- if .Values.gitRepo.url }}
# ApplicationSet for all infrastructure apps
# Auto-discovers apps in apps/infra/* directory via app-config.yaml files
# To add a new infra app: create apps/infra/<app-name>/ with Chart.yaml, values.yaml, app-config.yaml, and optionally values-<cluster>.yaml files
# To scope an app to specific clusters: edit app-config.yaml and list only the desired clusters in targetClusters
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: infra-apps
  namespace: argocd
  annotations:
    # Helm hooks ensure this is created AFTER ArgoCD CRDs are installed
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: {{ .Values.gitRepo.url }}
        revision: {{ .Values.gitRepo.revision }}
        files:
          - path: {{ .Values.gitRepo.path }}/infra/*/app-config.yaml
  template:
    metadata:
      name: '{{ `{{ index .path.segments 2 }}` }}'
    spec:
      project: default
      source:
        repoURL: {{ .Values.gitRepo.url }}
        targetRevision: {{ .Values.gitRepo.revision }}
        path: '{{ `{{ .path.path }}` }}'
        helm:
          valueFiles:
            - values.yaml
            - values-{{ .Values.clusterName }}.yaml
          # Skip missing per-cluster values files - allows apps to work with just values.yaml
          ignoreMissingValueFiles: true
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{ `{{ index .path.segments 2 }}` }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
  # Filter apps based on targetClusters in app-config.yaml
  # If current cluster is not in targetClusters, set empty name to skip Application creation
  templatePatch: |
    {{`{{- $currentCluster := "`}}{{ .Values.clusterName }}{{`" -}}`}}
    {{`{{- $targetClusters := .targetClusters | default (list) -}}`}}
    {{`{{- if not (has $currentCluster $targetClusters) }}`}}
    metadata:
      name: ""
    {{`{{- end }}`}}
{{- end }}
